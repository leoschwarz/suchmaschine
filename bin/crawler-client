#!/usr/bin/env ruby
require_relative '../lib/crawler/crawler.rb'

module Crawler
  class Client
    def launch
      @logger = Common::Logger.new({labels: {success: :Erfolge, failure: :Fehler, not_allowed: :Verboten}})
      @logger.add_output($stdout, Common::Logger::INFO)
      @progress = @logger.progress_logger(Common::OrderedHash.new([[:success, 0], [:failure, 0], [:not_allowed, 0]]))
      
      @logger.log_info("Crawler-Client wurde gestartet.")
      @logger.log_info("Threads: #{Config.crawler.threads}")
      @logger.log_info("Server:  #{Config.database_connection.host}:#{Config.database_connection.port}")
      Config.crawler.threads.times{ self.launch_thread }
      
      @progress.start_display(5.0, false)
    end
    
    def launch_thread
      Thread.new do
        loop do
          begin
            result_type = Crawler::Task.fetch.execute
            @progress[result_type] += 1
          rescue => e
            @logger.log_exception(e)
          end
        end
      end
    end
  end
end

if __FILE__ == $0
  Crawler::Client.new.launch
end
