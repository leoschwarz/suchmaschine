#!/usr/bin/env ruby
require_relative '../lib/common/common.rb'
require_relative '../lib/indexer/indexer.rb'

# TODO: Den Code übersichtlicher machen.
Thread.abort_on_exception = true

module Indexer
  class Main
    def initialize
      @logger = Common::Logger.new({labels: {tasks: "Aufgaben", tasks_per_second: "Aufgaben/s"}})
      @logger.add_output($stdout, Common::Logger::INFO)
      @progress = @logger.progress_logger(Common::OrderedHash.new([[:tasks, 0], [:tasks_per_second, nil]]))
      @progress[:tasks_per_second] = proc{|p| p.elapsed_time}
    end
    
    def run
      # In Threads einzelne Dokumente indexieren.
      @logger.log_info "10'000 Dokumente werden indexiert und anschliessend in den Hauptindex eingegliedert."
      @progress.start_display(5.0)
      
      cache = IndexingCache.new
      Common::WorkerThreads.new(10).run do
        while @progress[:tasks] < 10_000 && (doc_id = Indexer::Database.index_queue_fetch)
          task = Task.load(doc_id)
          task.run(cache) unless task.nil?
          
          @progress[:tasks] += 1
        end
      end
      @progress.stop_display
      cache.write_to_disk
      
      # Sortieren der Einträge beginnen...
      @logger.log_info "Sortieren der Zwischenergebnisse gestartet."
      temporary_words = cache.words
      cache = nil
      @logger.log_info "Anzahl zu sortierender Dateien: #{temporary_words.size}"
      
      @progress.restart_display
      Common::WorkerThreads.new(10).run do
        while (word = temporary_words.pop)
          # 1. Die (bereits vorsortierten) Blöcke des entsprechenden Posting laden.
          posting = Indexer::Postings.new(word, load: true)
          
          # 2. Das Posting sortieren...
          sorter = Indexer::PostingsSorter.new(posting)
          sorter.sort_blocks
          posting.save
          
          @progress[:tasks] += 1
        end
      end
      @progress.stop_display
    
      @logger.log_info "10'000 Dokumente erfolgreich indexiert und in Hauptindex eingegliedert."
    end
  end
end


if __FILE__ == $0
  Indexer::Main.new.run()
end
